

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tests for verifying implementations</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>

        <script src="http://sagecell.sagemath.org/static/jquery.min.js"></script>
        <script src="http://sagecell.sagemath.org/static/embedded_sagecell.js"></script>

        <script>sagecell.makeSagecell({inputLocation: ".sage"});</script>

        <style type="text/css">
                .sagecell .CodeMirror-scroll {
                        overflow-y: hidden;
                        overflow-x: auto;
                }
                .sagecell .CodeMirror {
                        height: auto;
                }
        </style>

    
    <link rel="top" title="Software engineering with exponential decay models" href="index.html" />
    <link rel="next" title="Sharing the software with other users" href="._main_softeng005.html" />
    <link rel="prev" title="User interfaces" href="._main_softeng003.html" />
 
  
       <style type="text/css">
         div.admonition {
           background-color: whiteSmoke;
           border: 1px solid #bababa;
         }
       </style>
      </head>
    
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="._main_softeng005.html" title="Sharing the software with other users"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="._main_softeng003.html" title="User interfaces"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Software engineering with exponential decay models</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="tests-for-verifying-implementations">
<h1>Tests for verifying implementations<a class="headerlink" href="#tests-for-verifying-implementations" title="Permalink to this headline">¶</a></h1>
<p>Any module with functions should have a set of tests that can
check the
correctness of the implementations.
There exists
well-established procedures and corresponding tools for automating
the execution of such tests. These tools allow large test sets to be
run with a one-line command, making it easy to check of the
still software works (as far as the
tests tell!). Here we shall illustrate two important
software testing techniques: <em>doctest</em> and <em>unit testing</em>.
The first one is Python specific, while unit testing is the dominating
test technique in the software industry today.</p>
<div class="section" id="doctests">
<h2>Doctests<a class="headerlink" href="#doctests" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-0"></span><p id="index-1">A doc string, the first string after the function header, is used to
document the purpose of functions and their arguments
(see the section <a class="reference internal" href="._main_softeng002.html#softeng1-basic-func"><span class="std std-ref">Implementing the numerical algorithm in a function</span></a>). Very often it
is instructive to include an example in the doc string
on how to use the function.
Interactive examples in the Python shell are most illustrative as
we can see the output resulting from the statements and expressions.
For example,
in the <code class="docutils literal"><span class="pre">solver</span></code> function, we can include an example on calling
this function and printing the computed <code class="docutils literal"><span class="pre">u</span></code> and <code class="docutils literal"><span class="pre">t</span></code> arrays:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>


<span class="sd">    &gt;&gt;&gt; u, t = solver(I=0.8, a=1.2, T=1.5, dt=0.5, theta=0.5)</span>
<span class="sd">    &gt;&gt;&gt; for n in range(len(t)):</span>
<span class="sd">    ...     print &#39;t=%.1f, u=%.14f&#39; % (t[n], u[n])</span>
<span class="sd">    t=0.0, u=0.80000000000000</span>
<span class="sd">    t=0.5, u=0.43076923076923</span>
<span class="sd">    t=1.0, u=0.23195266272189</span>
<span class="sd">    t=1.5, u=0.12489758761948</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>When such interactive demonstrations are inserted in doc strings,
Python&#8217;s <a class="reference external" href="http://docs.python.org/library/doctest.html">doctest</a>
module can be used to automate running all commands
in interactive sessions and compare new output with the output
appearing in the doc string.  All we have to do in the current example
is to run the module file <code class="docutils literal"><span class="pre">decay.py</span></code> with</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Terminal</span><span class="o">&gt;</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">doctest</span> <span class="n">decay</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>This command imports the <code class="docutils literal"><span class="pre">doctest</span></code> module, which runs all
doctests found in the file and reports discrepancies between
expected and computed output.
Alternatively, the test block in a module may run all doctests
by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>
</div>
<p>Doctests can also be embedded in nose/pytest unit tests
as explained in the next section.</p>
<div class="admonition-doctests-prevent-command-line-arguments admonition">
<p class="first admonition-title">Doctests prevent command-line arguments</p>
<p>No additional command-line argument is allowed when running doctests.
If your program relies on command-line input, make sure the doctests
can be run <em>without</em> such input on the command line.</p>
<p>However, you can simulate command-line input by filling <code class="docutils literal"><span class="pre">sys.argv</span></code>
with values, e.g.,</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span><span class="p">;</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="s">&#39;--I 1.0 --a 5&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>The execution command above will report any problem if a test fails.
As an illustration, let us alter the <code class="docutils literal"><span class="pre">u</span></code> value at <code class="docutils literal"><span class="pre">t=1.5</span></code> in
the output of the doctest by replacing the last digit <code class="docutils literal"><span class="pre">8</span></code> by <code class="docutils literal"><span class="pre">7</span></code>.
This edit triggers a report:</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python -m doctest decay.py
********************************************************
File &quot;decay.py&quot;, line ...
Failed example:
    for n in range(len(t)):
        print &#39;t=%.1f, u=%.14f&#39; % (t[n], u[n])
Expected:
    t=0.0, u=0.80000000000000
    t=0.5, u=0.43076923076923
    t=1.0, u=0.23195266272189
    t=1.5, u=0.12489758761948
Got:
    t=0.0, u=0.80000000000000
    t=0.5, u=0.43076923076923
    t=1.0, u=0.23195266272189
    t=1.5, u=0.12489758761947
</pre></div>
</div>
<div class="admonition-pay-attention-to-the-number-of-digits-in-doctest-results admonition">
<p class="first admonition-title">Pay attention to the number of digits in doctest results</p>
<p class="last">Note that in the output of <code class="docutils literal"><span class="pre">t</span></code> and <code class="docutils literal"><span class="pre">u</span></code> we write <code class="docutils literal"><span class="pre">u</span></code> with 14 digits.
Writing all 16 digits is not a good idea: if the tests are run on
different hardware, round-off errors might be different, and
the <code class="docutils literal"><span class="pre">doctest</span></code> module detects that the numbers are not precisely the same
and reports failures. In the present application, where <span class="math">\(0 &lt; u(t) \leq 0.8\)</span>,
we expect round-off errors to be of size <span class="math">\(10^{-16}\)</span>, so comparing 15
digits would probably be reliable, but we compare 14 to be on the
safe side. On the other hand, comparing a small number of digits may
hide software errors.</p>
</div>
<p>Doctests are highly encouraged as they do two things: 1) demonstrate
how a function is used and 2) test that the function works.</p>
</div>
<div class="section" id="unit-tests-and-test-functions">
<h2>Unit tests and test functions<a class="headerlink" href="#unit-tests-and-test-functions" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-2"></span><span class="target" id="index-3"></span><span class="target" id="index-4"></span><span class="target" id="index-5"></span><p id="index-6">The unit testing technique consists of identifying smaller units
of code and writing one or more tests for
each unit. One unit can typically be a function.
Each test should, ideally, not depend on the outcome of
other tests. The recommended practice is actually to
design and write the unit tests first and <em>then</em> implement the functions!</p>
<p>In scientific computing it is not always obvious how to best perform
unit testing. The units are naturally larger than in non-scientific
software. Very often the solution procedure of a mathematical problem
identifies a unit, such as our <code class="docutils literal"><span class="pre">solver</span></code> function.</p>
<span class="target" id="index-7"></span><div class="section" id="two-python-test-frameworks-nose-and-pytest">
<span id="index-8"></span><h3>Two Python test frameworks: nose and pytest<a class="headerlink" href="#two-python-test-frameworks-nose-and-pytest" title="Permalink to this headline">¶</a></h3>
<p>Python offers two very easy-to-use software frameworks for implementing
unit tests: nose and pytest. These work (almost) in the same way,
but our recommendation is to go for pytest.</p>
</div>
<div class="section" id="test-function-requirements">
<h3>Test function requirements<a class="headerlink" href="#test-function-requirements" title="Permalink to this headline">¶</a></h3>
<p>For a test to qualify as a <em>test function</em> in nose or pytest, three
rules must be followed:</p>
<blockquote>
<div><ol class="arabic simple">
<li>The function name must start with <code class="docutils literal"><span class="pre">test_</span></code>.</li>
<li>Function arguments are not allowed.</li>
<li>An <code class="docutils literal"><span class="pre">AssertionError</span></code> exception must be raised if the test fails.</li>
</ol>
</div></blockquote>
<p>A specific example might be illustrative before proceeding.
We have the following function that we want to test:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">double</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span>
</pre></div>
</div>
<p>The corresponding test function could, in principle, have been written
as</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_double</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test that double(n) works for one specific n.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">4</span>
    <span class="n">computed</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expected</span> <span class="o">!=</span> <span class="n">computed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span>
</pre></div>
</div>
<p>The last two lines, however, are never written like this in test functions.
Instead, Python&#8217;s <code class="docutils literal"><span class="pre">assert</span></code> statement is used: <code class="docutils literal"><span class="pre">assert</span> <span class="pre">success,</span> <span class="pre">msg</span></code>, where
<code class="docutils literal"><span class="pre">success</span></code> is a boolean variable, which is <code class="docutils literal"><span class="pre">False</span></code> if the test fails, and
<code class="docutils literal"><span class="pre">msg</span></code> is <em>an optional</em> message string that is printed when the test fails.
A better version of the test function is therefore</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_double</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test that double(n) works for one specific n.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">4</span>
    <span class="n">computed</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;expected </span><span class="si">%g</span><span class="s">, computed </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">computed</span><span class="p">)</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">expected</span> <span class="o">==</span> <span class="n">computed</span>
    <span class="k">assert</span> <span class="n">success</span><span class="p">,</span> <span class="n">msg</span>
</pre></div>
</div>
</div>
<div class="section" id="comparison-of-real-numbers">
<h3>Comparison of real numbers<a class="headerlink" href="#comparison-of-real-numbers" title="Permalink to this headline">¶</a></h3>
<p>Because of the finite precision arithmetics on a computer, which gives
rise to round-off errors, the <code class="docutils literal"><span class="pre">==</span></code> operator is not suitable for
checking whether two real numbers are equal. Obviously, this principle
also applies to tests in test functions.
We must therefore replace <code class="docutils literal"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">b</span></code> by a comparison
based on a tolerance <code class="docutils literal"><span class="pre">tol</span></code>: <code class="docutils literal"><span class="pre">abs(a-b)</span> <span class="pre">&lt;</span> <span class="pre">tol</span></code>. The next example illustrates
the problem and its solution.</p>
<p>Here is a slightly different function that
we want to test:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">third</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">/</span><span class="mf">3.</span>
</pre></div>
</div>
<p>We write a test function where the expected result is computed as
<span class="math">\(\frac{1}{3}x\)</span> rather than <span class="math">\(x/3\)</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_third</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Check that third(x) works for many x values.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="n">x</span>
        <span class="n">computed</span> <span class="o">=</span> <span class="n">third</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">expected</span> <span class="o">==</span> <span class="n">computed</span>
        <span class="k">assert</span> <span class="n">success</span>
</pre></div>
</div>
<p>This <code class="docutils literal"><span class="pre">test_third</span></code> function executes silently, i.e., no failure,
until <code class="docutils literal"><span class="pre">x</span></code> becomes 0.15. Then round-off errors make the <code class="docutils literal"><span class="pre">==</span></code> comparison
<code class="docutils literal"><span class="pre">False</span></code>. In fact, seven of the <code class="docutils literal"><span class="pre">x</span></code> values above face this problem.
The solution is to compare <code class="docutils literal"><span class="pre">expected</span></code> and <code class="docutils literal"><span class="pre">computed</span></code>
with a small tolerance:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_third</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Check that third(x) works for many x values.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">x</span>
        <span class="n">computed</span> <span class="o">=</span> <span class="n">third</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-15</span>
        <span class="n">success</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expected</span> <span class="o">-</span> <span class="n">computed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span>
        <span class="k">assert</span> <span class="n">success</span>
</pre></div>
</div>
<div class="admonition-always-compare-real-numbers-with-a-tolerance admonition">
<p class="first admonition-title">Always compare real numbers with a tolerance</p>
<p>Real numbers should never be compared with the <code class="docutils literal"><span class="pre">==</span></code> operator, but always
with the absolute value of the difference and a tolerance.
So, replace <code class="docutils literal"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">b</span></code>, if <code class="docutils literal"><span class="pre">a</span></code> and/or <code class="docutils literal"><span class="pre">b</span></code> is <code class="docutils literal"><span class="pre">float</span></code>, by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
<span class="nb">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span>
</pre></div>
</div>
<p class="last">The suitable size of <code class="docutils literal"><span class="pre">tol</span></code> depends on the size of <code class="docutils literal"><span class="pre">a</span></code> and <code class="docutils literal"><span class="pre">b</span></code>
(see <a class="reference internal" href="._main_softeng008.html#softeng1-exer-tol"><span class="std std-ref">Problem 5: Experiment with tolerances in comparisons</span></a>).</p>
</div>
</div>
<div class="section" id="special-assert-functions-from-nose">
<h3>Special assert functions from nose<a class="headerlink" href="#special-assert-functions-from-nose" title="Permalink to this headline">¶</a></h3>
<p>Test frameworks often contain more tailored
<em>assert functions</em> that can be called instead of using the <code class="docutils literal"><span class="pre">assert</span></code>
statement. For example, comparing two objects within
a tolerance, as in the present
case, can be done by the <code class="docutils literal"><span class="pre">assert_almost_equal</span></code> from the nose
framework:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nose.tools</span> <span class="kn">as</span> <span class="nn">nt</span>

<span class="k">def</span> <span class="nf">test_third</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mf">0.15</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">x</span>
    <span class="n">computed</span> <span class="o">=</span> <span class="n">third</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">assert_almost_equal</span><span class="p">(</span>
        <span class="n">expected</span><span class="p">,</span> <span class="n">computed</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1E-15</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">=</span><span class="s">&#39;diff=</span><span class="si">%.17E</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expected</span> <span class="o">-</span> <span class="n">computed</span><span class="p">))</span>
</pre></div>
</div>
<p>Whether to use the plain <code class="docutils literal"><span class="pre">assert</span></code> statement with a comparison based on
a tolerance or to use the ready-made function <code class="docutils literal"><span class="pre">assert_almost_equal</span></code>
depends on the programmer&#8217;s preference. The examples used in the
documentation of the pytest framework stick to the plain <code class="docutils literal"><span class="pre">assert</span></code>
statement.</p>
</div>
<div class="section" id="locating-test-functions">
<h3>Locating test functions<a class="headerlink" href="#locating-test-functions" title="Permalink to this headline">¶</a></h3>
<p>Test functions can reside in a module together with the functions they
are supposed to verify, or the test functions can be collected in
separate files having names starting with <code class="docutils literal"><span class="pre">test</span></code>. Actually,
nose and pytest can recursively run all test functions
in all <code class="docutils literal"><span class="pre">test*.py</span></code>
files in the current directory, as well as in all subdirectories!</p>
<p>The <a class="reference external" href="http://tinyurl.com/ofkw6kc/softeng/decay.py">decay.py</a> module file features
test functions in the module, but we could equally well have made
a subdirectory <code class="docutils literal"><span class="pre">tests</span></code> and put the test functions in
<a class="reference external" href="http://tinyurl.com/ofkw6kc/softeng/tests/test_decay.py">tests/test_decay.py</a>.</p>
</div>
<div class="section" id="running-tests">
<h3>Running tests<a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h3>
<p>To run all test functions in the file <code class="docutils literal"><span class="pre">decay.py</span></code> do</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; nosetests -s -v decay.py
Terminal&gt; py.test -s -v decay.py
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">-s</span></code> option ensures that output from the test functions is printed
in the terminal window, while <code class="docutils literal"><span class="pre">-v</span></code> prints the outcome of each individual
test function.</p>
<p>Alternatively, if the test functions are located in some separate
<code class="docutils literal"><span class="pre">test*.py</span></code> files,
we can just write</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; py.test -s -v
</pre></div>
</div>
<p>to <em>recursively</em> run <em>all</em> test functions in the current
directory tree. The corresponding</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; nosetests -s -v
</pre></div>
</div>
<p>command does the same, but requires subdirectory names to start
with <code class="docutils literal"><span class="pre">test</span></code> or end with <code class="docutils literal"><span class="pre">_test</span></code> or <code class="docutils literal"><span class="pre">_tests</span></code> (which is a good habit anyway).
An example of a <code class="docutils literal"><span class="pre">tests</span></code> directory with a <code class="docutils literal"><span class="pre">test*.py</span></code>
file is found in <a class="reference external" href="http://tinyurl.com/ofkw6kc/softeng/tests">src/softeng1/tests</a>.</p>
</div>
<div class="section" id="embedding-doctests-in-a-test-function">
<span id="index-9"></span><h3>Embedding doctests in a test function<a class="headerlink" href="#embedding-doctests-in-a-test-function" title="Permalink to this headline">¶</a></h3>
<p>Doctests can also be executed from nose/pytest unit tests. Here
is an example of a file <a class="reference external" href="http://tinyurl.com/ofkw6kc/softeng/tests/test_decay_doctest.py">test_decay_doctest.py</a> where we in the test block run all the doctests
in the imported module <code class="docutils literal"><span class="pre">decay</span></code>, but we also include a local test function that
does the same:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">decay</span>
<span class="kn">import</span> <span class="nn">doctest</span>

<span class="k">def</span> <span class="nf">test_decay_module_with_doctest</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Doctest embedded in a nose/pytest unit test.&quot;&quot;&quot;</span>
    <span class="c"># Test all functions with doctest in module decay</span>
    <span class="n">failure_count</span><span class="p">,</span> <span class="n">test_count</span> <span class="o">=</span> <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">decay</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">failure_count</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c"># Run all functions with doctests in this module</span>
    <span class="n">failure_count</span><span class="p">,</span> <span class="n">test_count</span> <span class="o">=</span> <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">decay</span><span class="p">)</span>
</pre></div>
</div>
<p>Running this file as a program from the command line
triggers the <code class="docutils literal"><span class="pre">doctest.testmod</span></code> call
in the test block, while applying <code class="docutils literal"><span class="pre">py.test</span></code> or <code class="docutils literal"><span class="pre">nosetests</span></code> to the file triggers
an import of the file and execution of the test function
<code class="docutils literal"><span class="pre">test_decay_modue_with_doctest</span></code>.</p>
</div>
<div class="section" id="installing-nose-and-pytest">
<h3>Installing nose and pytest<a class="headerlink" href="#installing-nose-and-pytest" title="Permalink to this headline">¶</a></h3>
<p>With <code class="docutils literal"><span class="pre">pip</span></code> available, it is trivial to install nose and/or pytest:
<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">nose</span></code> and <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">pytest</span></code>.</p>
</div>
</div>
<div class="section" id="test-function-for-the-solver">
<h2>Test function for the solver<a class="headerlink" href="#test-function-for-the-solver" title="Permalink to this headline">¶</a></h2>
<p>Finding good test problems for verifying the implementation of numerical
methods is a topic on its own. The challenge is that we very seldom know
what the numerical errors are. For the present model problem
<a class="reference internal" href="._main_softeng002.html#eq-softeng1-ode"><span class="std std-ref">(3.1)</span></a>-<a class="reference internal" href="._main_softeng002.html#eq-softeng1-u0"><span class="std std-ref">(3.2)</span></a> solved by
<a class="reference internal" href="._main_softeng002.html#eq-softeng1-utheta"><span class="std std-ref">(3.3)</span></a> one can, fortunately, derive a formula for
the numerical approximation:</p>
<div class="math">
\[u^n = I\left(
\frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t}
\right)^n{\thinspace .}\]</div>
<p>Then we know that the implementation should
produce numbers that agree with this formula to machine precision.
The formula for <span class="math">\(u^n\)</span> is known as an <em>exact discrete solution</em> of the
problem and can be coded as</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return exact discrete solution of the numerical schemes.&quot;&quot;&quot;</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>  <span class="c"># avoid integer division</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">A</span><span class="o">**</span><span class="n">n</span>
</pre></div>
</div>
<p>A test function can evaluate this solution on a time mesh
and check that the <code class="docutils literal"><span class="pre">u</span></code> values produced by the <code class="docutils literal"><span class="pre">solver</span></code> function
do not deviate with more than a small tolerance:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_exact_discrete_solution</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Check that solver reproduces the exact discr. sol.&quot;&quot;&quot;</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">I</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>  <span class="c"># no of steps</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">Nt</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>

    <span class="c"># Evaluate exact discrete solution on the mesh</span>
    <span class="n">u_de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>

    <span class="c"># Find largest deviation</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_de</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span>
    <span class="k">assert</span> <span class="n">success</span>
</pre></div>
</div>
<p>Among important things to consider when constructing test functions
is testing the effect of wrong input to the function being tested.
In our <code class="docutils literal"><span class="pre">solver</span></code> function, for example, integer values of <span class="math">\(a\)</span>, <span class="math">\(\Delta t\)</span>, and
<span class="math">\(\theta\)</span> may cause unintended integer
division. We should therefore add a test to make sure our <code class="docutils literal"><span class="pre">solver</span></code>
function does not fall into this potential trap:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_potential_integer_division</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Choose variables that can trigger integer division.&quot;&quot;&quot;</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dt</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">Nt</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">u_de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_de</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mf">1E-14</span>
</pre></div>
</div>
</div>
<div class="section" id="test-function-for-reading-positional-command-line-arguments">
<h2>Test function for reading positional command-line arguments<a class="headerlink" href="#test-function-for-reading-positional-command-line-arguments" title="Permalink to this headline">¶</a></h2>
<p>The function <code class="docutils literal"><span class="pre">read_command_line_positional</span></code> extracts numbers from the
command line. To test it, we must decide on a set of values for
the input data, fill <code class="docutils literal"><span class="pre">sys.argv</span></code>
accordingly, and check that we get the expected values:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_read_command_line_positional</span><span class="p">():</span>
    <span class="c"># Decide on a data set of input parameters</span>
    <span class="n">I</span> <span class="o">=</span> <span class="mf">1.6</span><span class="p">;</span>  <span class="n">a</span> <span class="o">=</span> <span class="mf">1.8</span><span class="p">;</span>  <span class="n">T</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">;</span>  <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">dt_values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span>
    <span class="c"># Expected return from read_command_line_positional</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt_values</span><span class="p">]</span>
    <span class="c"># Construct corresponding sys.argv array</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="s">&#39;CN&#39;</span><span class="p">]</span> <span class="o">+</span> \
               <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">]</span>
    <span class="n">computed</span> <span class="o">=</span> <span class="n">read_command_line_positional</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">expected_arg</span><span class="p">,</span> <span class="n">computed_arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">computed</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">expected_arg</span> <span class="o">==</span> <span class="n">computed_arg</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal"><span class="pre">sys.argv[0]</span></code> is always the program name and that we have to
copy that string from the original <code class="docutils literal"><span class="pre">sys.argv</span></code> array to the new one we
construct in the test function. (Actually, this test function destroys
the original <code class="docutils literal"><span class="pre">sys.argv</span></code> that Python fetched from the command line.)</p>
<p>Any numerical code writer should always be skeptical to the use of the exact
equality operator <code class="docutils literal"><span class="pre">==</span></code> in test functions, since round-off errors often
come into play. Here, however, we set some real values, convert them
to strings and convert back again to real numbers (of the same precision).
This string-number conversion does not involve any finite precision
arithmetics effects so we
can safely use <code class="docutils literal"><span class="pre">==</span></code> in tests. Note also that the last element in
<code class="docutils literal"><span class="pre">expected</span></code> and <code class="docutils literal"><span class="pre">computed</span></code> is the list <code class="docutils literal"><span class="pre">dt_values</span></code>, and <code class="docutils literal"><span class="pre">==</span></code> works
for comparing two lists as well.</p>
</div>
<div class="section" id="test-function-for-reading-option-value-pairs">
<h2>Test function for reading option-value pairs<a class="headerlink" href="#test-function-for-reading-option-value-pairs" title="Permalink to this headline">¶</a></h2>
<p>The function <code class="docutils literal"><span class="pre">read_command_line_argparse</span></code> can be verified with a
test function that has the same setup as <code class="docutils literal"><span class="pre">test_read_command_line_positional</span></code>
above.
However, the construction of the command line is a bit more complicated.
We find it convenient to construct the line as a string and then
split the line into words to get the desired list <code class="docutils literal"><span class="pre">sys.argv</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_read_command_line_argparse</span><span class="p">():</span>
    <span class="n">I</span> <span class="o">=</span> <span class="mf">1.6</span><span class="p">;</span>  <span class="n">a</span> <span class="o">=</span> <span class="mf">1.8</span><span class="p">;</span>  <span class="n">T</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">;</span>  <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">dt_values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span>
    <span class="c"># Expected return from read_command_line_argparse</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt_values</span><span class="p">]</span>
    <span class="c"># Construct corresponding sys.argv array</span>
    <span class="n">command_line</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> --a </span><span class="si">%s</span><span class="s"> --I </span><span class="si">%s</span><span class="s"> --T </span><span class="si">%s</span><span class="s"> --scheme CN --dt &#39;</span> <span class="o">%</span> \
                   <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="n">command_line</span> <span class="o">+=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">])</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">command_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">computed</span> <span class="o">=</span> <span class="n">read_command_line_argparse</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">expected_arg</span><span class="p">,</span> <span class="n">computed_arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">computed</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">expected_arg</span> <span class="o">==</span> <span class="n">computed_arg</span>
</pre></div>
</div>
<p>Recall that the Python function <code class="docutils literal"><span class="pre">zip</span></code> enables iteration over
several lists, tuples, or arrays at the same time.</p>
<div class="admonition-let-silent-test-functions-speak-up-during-development admonition">
<p class="first admonition-title">Let silent test functions speak up during development</p>
<p>When you develop test functions in a module, it is common to use IPython
for interactive experimentation:</p>
<div class="highlight-ipy"><div class="highlight"><pre><span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">decay</span>

<span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">decay</span><span class="o">.</span><span class="n">test_read_command_line_argparse</span><span class="p">()</span>
</pre></div>
</div>
<p>Note that a working test function is completely silent! Many
find it psychologically annoying to convince themselves that a
completely silent function is doing the right things. It can therefore,
during development of a test function, be convenient to insert
print statements in the function to monitor that the function body
is indeed executed. For example, one can print the expected and
computed values in the terminal window:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_read_command_line_argparse</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="k">for</span> <span class="n">expected_arg</span><span class="p">,</span> <span class="n">computed_arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">computed</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">expected_arg</span><span class="p">,</span> <span class="n">computed_arg</span>
        <span class="k">assert</span> <span class="n">expected_arg</span> <span class="o">==</span> <span class="n">computed_arg</span>
</pre></div>
</div>
<p>After performing this edit, we want to run the test again, but
in IPython the module must first be reloaded (reimported):</p>
<div class="highlight-ipy"><div class="highlight"><pre><span class="n">In</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="nb">reload</span><span class="p">(</span><span class="n">decay</span><span class="p">)</span>  <span class="c"># force new import</span>

<span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">decay</span><span class="o">.</span><span class="n">test_read_command_line_argparse</span><span class="p">()</span>
<span class="mf">1.6</span> <span class="mf">1.6</span>
<span class="mf">1.8</span> <span class="mf">1.8</span>
<span class="mf">2.2</span> <span class="mf">2.2</span>
<span class="mf">0.5</span> <span class="mf">0.5</span>
<span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span>
</pre></div>
</div>
<p class="last">Now we clearly see the objects that are compared.</p>
</div>
</div>
<div class="section" id="classical-class-based-unit-testing">
<span id="softeng1-basic-unittest"></span><h2>Classical class-based unit testing<a class="headerlink" href="#classical-class-based-unit-testing" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-10"></span><span class="target" id="index-11"></span><p id="index-12">The test functions written for the nose and pytest frameworks are
very straightforward and to the point, with no framework-required boilerplate
code. We just write the statements we need to get the computations and
comparisons done, before applying the required <code class="docutils literal"><span class="pre">assert</span></code>.</p>
<p>The classical way of implementing unit tests (which derives from the
JUnit object-oriented tool in Java) leads to much more comprehensive
implementations with a lot of boilerplate code.  Python comes with a
built-in module <code class="docutils literal"><span class="pre">unittest</span></code> for doing this type of classical unit
tests. Although nose or pytest are much more convenient to use than
<code class="docutils literal"><span class="pre">unittest</span></code>, class-based unit testing in the style of <code class="docutils literal"><span class="pre">unittest</span></code> has a
very strong position in computer science and is so widespread in
the software industry that
even computational scientists should have an idea how such unit test
code is written. A short demo of <code class="docutils literal"><span class="pre">unittest</span></code> is therefore included
next. (Readers who are not familiar with object-oriented programming
in Python may find the text hard to understand, but one can safely
jump to the next section.)</p>
<span class="target" id="index-13"></span><p id="index-14">Suppose we have a function <code class="docutils literal"><span class="pre">double(x)</span></code> in a module file <code class="docutils literal"><span class="pre">mymod.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">double</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span>
</pre></div>
</div>
<p>Unit testing with the aid of the <code class="docutils literal"><span class="pre">unittest</span></code> module
consists of writing a file <code class="docutils literal"><span class="pre">test_mymod.py</span></code> for testing the functions
in <code class="docutils literal"><span class="pre">mymod.py</span></code>. The individual tests must be methods with names
starting with <code class="docutils literal"><span class="pre">test_</span></code> in a class derived from class <code class="docutils literal"><span class="pre">TestCase</span></code> in
<code class="docutils literal"><span class="pre">unittest</span></code>. With one test method for the function <code class="docutils literal"><span class="pre">double</span></code>, the
<code class="docutils literal"><span class="pre">test_mymod.py</span></code> file becomes</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">mymod</span>

<span class="k">class</span> <span class="nc">TestMyCode</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_double</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span>
        <span class="n">computed</span> <span class="o">=</span> <span class="n">mymod</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">computed</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>The test is run by executing the test file <code class="docutils literal"><span class="pre">test_mymod.py</span></code> as a standard
Python program. There is no support in <code class="docutils literal"><span class="pre">unittest</span></code> for automatically
locating and running all tests in all test files in a directory tree.</p>
<p>We could use the basic <code class="docutils literal"><span class="pre">assert</span></code> statement as we did with nose and pytest
functions, but those who write code based on <code class="docutils literal"><span class="pre">unittest</span></code> almost
exclusively use the wide range of built-in assert functions such
as <code class="docutils literal"><span class="pre">assertEqual</span></code>, <code class="docutils literal"><span class="pre">assertNotEqual</span></code>, <code class="docutils literal"><span class="pre">assertAlmostEqual</span></code>, to mention
some of them.</p>
<p>Translation of the test functions from the previous sections
to <code class="docutils literal"><span class="pre">unittest</span></code> means making a new file <code class="docutils literal"><span class="pre">test_decay.py</span></code> file with a
test class <code class="docutils literal"><span class="pre">TestDecay</span></code> where the stand-alone functions for
nose/pytest now become methods in this class.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">decay</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">TestDecay</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_exact_discrete_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">I</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.8</span>
        <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>  <span class="c"># no of steps</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">decay</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">Nt</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
        <span class="c"># Evaluate exact discrete solution on the mesh</span>
        <span class="n">u_de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_de</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c"># largest deviation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1E-14</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_potential_integer_division</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1E-14</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_read_command_line_positional</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="k">for</span> <span class="n">expected_arg</span><span class="p">,</span> <span class="n">computed_arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">computed</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_arg</span><span class="p">,</span> <span class="n">computed_arg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_read_command_line_argparse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <center>
            <p class="logo"><a href="http://cbc.simula.no/" title="Go to Center for Biomedical Computing">
              <img class="logo" src="_static/cbc_logo.png" alt="Logo"/>
            </a></p>
            </center>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tests for verifying implementations</a><ul>
<li><a class="reference internal" href="#doctests">Doctests</a></li>
<li><a class="reference internal" href="#unit-tests-and-test-functions">Unit tests and test functions</a><ul>
<li><a class="reference internal" href="#two-python-test-frameworks-nose-and-pytest">Two Python test frameworks: nose and pytest</a></li>
<li><a class="reference internal" href="#test-function-requirements">Test function requirements</a></li>
<li><a class="reference internal" href="#comparison-of-real-numbers">Comparison of real numbers</a></li>
<li><a class="reference internal" href="#special-assert-functions-from-nose">Special assert functions from nose</a></li>
<li><a class="reference internal" href="#locating-test-functions">Locating test functions</a></li>
<li><a class="reference internal" href="#running-tests">Running tests</a></li>
<li><a class="reference internal" href="#embedding-doctests-in-a-test-function">Embedding doctests in a test function</a></li>
<li><a class="reference internal" href="#installing-nose-and-pytest">Installing nose and pytest</a></li>
</ul>
</li>
<li><a class="reference internal" href="#test-function-for-the-solver">Test function for the solver</a></li>
<li><a class="reference internal" href="#test-function-for-reading-positional-command-line-arguments">Test function for reading positional command-line arguments</a></li>
<li><a class="reference internal" href="#test-function-for-reading-option-value-pairs">Test function for reading option-value pairs</a></li>
<li><a class="reference internal" href="#classical-class-based-unit-testing">Classical class-based unit testing</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="._main_softeng003.html"
                        title="previous chapter">User interfaces</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="._main_softeng005.html"
                        title="next chapter">Sharing the software with other users</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/._main_softeng004.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="._main_softeng005.html" title="Sharing the software with other users"
             >next</a> |</li>
        <li class="right" >
          <a href="._main_softeng003.html" title="User interfaces"
             >previous</a> |</li>
        <li><a href="index.html">Software engineering with exponential decay models</a> &raquo;</li> 
      </ul>
    </div>
<div class="wrapper">
  <div class="footer">
  <a href="http://cbc.simula.no"><img src="_static/cbc_banner.png" width="100%"><a>
  </div>
</div>

  </body>
</html>